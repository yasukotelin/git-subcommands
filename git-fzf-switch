#!/bin/bash

# Git ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰: git fzf-switch
# fzfã‚’ä½¿ã£ã¦ãƒ–ãƒ©ãƒ³ãƒã‚’é¸æŠã—ã¦git switchã‚’å®Ÿè¡Œ

# å¿…è¦ãªã‚³ãƒãƒ³ãƒ‰ã®å­˜åœ¨ç¢ºèª
if ! command -v fzf &> /dev/null; then
    echo "Error: fzf is not installed. Please install fzf first."
    exit 1
fi

# Gitãƒªãƒã‚¸ãƒˆãƒªã‹ã©ã†ã‹ã®ç¢ºèª
if ! git rev-parse --git-dir &> /dev/null; then
    echo "Error: Not in a git repository"
    exit 1
fi

# ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
current_branch=$(git branch --show-current)

# ãƒ–ãƒ©ãƒ³ãƒä¸€è¦§ã‚’å–å¾—ï¼ˆæ›´æ–°æ—¥æ™‚é †ã€ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã¯é™¤å¤–ï¼‰
branches=$(git for-each-ref --format='%(refname:short)' \
    --sort=-committerdate \
    refs/heads refs/remotes \
    | grep -v "^${current_branch}$" \
    | sed 's|^origin/||' \
    | awk '!seen[$0]++')

# ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®é–¢æ•°ã‚’å®šç¾©
preview_command='
    branch={}
    echo "=== Branch: $branch ==="
    echo
    
    # ãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°ã‚³ãƒŸãƒƒãƒˆæƒ…å ±
    echo "ğŸ“… Latest commit:"
    git log --oneline --format="%C(yellow)%h%C(reset) %C(green)%ad%C(reset) %s %C(blue)(%an)%C(reset)" \
        --date=relative -n 1 "$branch" 2>/dev/null || echo "No commits found"
    echo
    
    # ãƒ–ãƒ©ãƒ³ãƒã®ä½œæˆæ—¥æ™‚
    echo "ğŸ• Branch created:"
    git log --reverse --format="%C(green)%ad%C(reset) %C(blue)(%an)%C(reset)" \
        --date=relative -n 1 "$branch" 2>/dev/null || echo "Unknown"
    echo
    
    # ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã¨ã®å·®åˆ†çµ±è¨ˆ
    if [ "$branch" != "'"$current_branch"'" ]; then
        echo "ğŸ“Š Diff with current branch ('"$current_branch"'):"
        git diff --stat "'"$current_branch"'"..."$branch" 2>/dev/null || echo "No differences"
        echo
    fi
    
    # æœ€è¿‘ã®ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ï¼ˆ5ä»¶ï¼‰
    echo "ğŸ“‹ Recent commits:"
    git log --oneline --format="%C(yellow)%h%C(reset) %C(green)%ad%C(reset) %s" \
        --date=short -n 5 "$branch" 2>/dev/null || echo "No commits found"
'

# fzfã§ãƒ–ãƒ©ãƒ³ãƒã‚’é¸æŠ
selected_branch=$(echo "$branches" | fzf \
    --prompt="Select branch to switch: " \
    --height=80% \
    --layout=reverse \
    --border \
    --preview="$preview_command" \
    --preview-window=right:60% \
    --header="Current: $current_branch | Press Enter to switch" \
    --bind="ctrl-r:reload(git for-each-ref --format='%(refname:short)' --sort=-committerdate refs/heads refs/remotes | grep -v '^$current_branch$' | sed 's|^origin/||' | awk '!seen[\$0]++')")

# é¸æŠã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
if [ -z "$selected_branch" ]; then
    echo "No branch selected. Cancelled."
    exit 0
fi

# é¸æŠã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒã«åˆ‡ã‚Šæ›¿ãˆ
echo "Switching to branch: $selected_branch"

# ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã¯æ–°ã—ã„ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
if git branch -r | grep -q "origin/$selected_branch" && ! git branch | grep -q "^..${selected_branch}$"; then
    echo "Creating local branch from remote: $selected_branch"
    git switch -c "$selected_branch" "origin/$selected_branch"
else
    git switch "$selected_branch"
fi

# çµæœã‚’è¡¨ç¤º
if [ $? -eq 0 ]; then
    echo "âœ… Successfully switched to branch: $selected_branch"
    echo
    echo "ğŸ“‹ Latest commit on this branch:"
    git log --oneline --format="%C(yellow)%h%C(reset) %C(green)%ad%C(reset) %s %C(blue)(%an)%C(reset)" \
        --date=relative -n 1
else
    echo "âŒ Failed to switch to branch: $selected_branch"
    exit 1
fi
