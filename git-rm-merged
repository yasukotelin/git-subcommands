#!/bin/bash

# Git ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰: git rm-merged
# ãƒãƒ¼ã‚¸æ¸ˆã¿ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ãƒ³ãƒã‚’ä¸€æ‹¬å‰Šé™¤

# Gitãƒªãƒã‚¸ãƒˆãƒªã‹ã©ã†ã‹ã®ç¢ºèª
if ! git rev-parse --git-dir &> /dev/null; then
    echo "Error: Not in a git repository"
    exit 1
fi

# ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
current_branch=$(git branch --show-current)

# ãƒãƒ¼ã‚¸æ¸ˆã¿ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—ï¼ˆmain/masterã€developã€ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã‚’é™¤å¤–ï¼‰
merged_branches=$(git branch --merged | \
    grep -v "^\*" | \
    grep -v "^..main$" | \
    grep -v "^..master$" | \
    grep -v "^..develop$" | \
    grep -v "^..${current_branch}$" | \
    sed 's/^..//')

# ãƒãƒ¼ã‚¸æ¸ˆã¿ãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
if [ -z "$merged_branches" ]; then
    echo "âœ… No merged branches found to delete."
    exit 0
fi

# ãƒãƒ¼ã‚¸æ¸ˆã¿ãƒ–ãƒ©ãƒ³ãƒã®ä¸€è¦§ã‚’è¡¨ç¤º
echo "ğŸ“‹ Following merged branches will be deleted:"
echo "----------------------------------------"
echo "$merged_branches" | while read -r branch; do
    if [ -n "$branch" ]; then
        # ãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’è¡¨ç¤º
        last_commit=$(git log --oneline --format="%h %ad %s" --date=short -n 1 "$branch" 2>/dev/null)
        echo "  ğŸŒ¿ $branch"
        echo "     â””â”€ $last_commit"
    fi
done
echo "----------------------------------------"

# ãƒ–ãƒ©ãƒ³ãƒæ•°ã‚’æ•°ãˆã‚‹
branch_count=$(echo "$merged_branches" | grep -c "^.")
echo "ğŸ“Š Total: $branch_count branches"
echo

# ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
echo "âš ï¸  Are you sure you want to delete these merged branches?"
echo "   Current branch: $current_branch"
echo
read -p "Continue? (y/N): " -n 1 -r
echo

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¢ºèª
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "âŒ Cancelled. No branches were deleted."
    exit 0
fi

# ãƒ–ãƒ©ãƒ³ãƒã®å‰Šé™¤ã‚’å®Ÿè¡Œ
echo "ğŸ—‘ï¸  Deleting merged branches..."
deleted_count=0
failed_count=0

echo "$merged_branches" | while read -r branch; do
    if [ -n "$branch" ]; then
        if git branch -d "$branch" &> /dev/null; then
            echo "  âœ… Deleted: $branch"
            ((deleted_count++))
        else
            echo "  âŒ Failed to delete: $branch"
            ((failed_count++))
        fi
    fi
done

# çµæœã‚µãƒãƒªãƒ¼
echo
echo "ğŸ“Š Summary:"
echo "  âœ… Deleted: $deleted_count branches"
if [ $failed_count -gt 0 ]; then
    echo "  âŒ Failed: $failed_count branches"
fi